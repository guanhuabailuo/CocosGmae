"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.http_quest = exports.loadCert = void 0;
const HTTPS = __importStar(require("https"));
const HTTP = __importStar(require("http"));
const URL = __importStar(require("url"));
const fs_1 = require("fs");
var timeout_num = 30 * 1000;
var taskGenId = 0;
function makeTaskId() {
    ++taskGenId;
    return taskGenId;
}
var task_cache = {};
let cert_cache = {};
function loadCert(name, cert_path, key_path, passphrase) {
    try {
        cert_cache[name] = {
            cert: fs_1.readFileSync(cert_path),
            key: fs_1.readFileSync(key_path),
            pass: passphrase
        };
        return true;
    }
    catch (e) {
        return false;
    }
}
exports.loadCert = loadCert;
/**
 * 异步流程执行网络请求
 * @param type
 * @param url
 * @param data
 * @param retry
 * @param headers
 * @param dtype
 * @param rtype
 */
function http_quest(type, url, data = {}, retry = 0, headers = {}, _option) {
    // 这里url增加一个 http https 头检查
    let checkHead = url.slice(0, 7);
    if (checkHead != 'http://' && checkHead != 'https:/') {
        // 自动增加一个头上去
        url = 'http://' + url;
    }
    type = type.toLowerCase();
    return new Promise(function (resolve, reject) {
        let option = {};
        if (typeof _option == 'string') {
            option = { dtype: _option };
        }
        else {
            option = Object.assign(option, _option || {});
        }
        var taskId = makeTaskId();
        task_cache[taskId] = {
            taskId: taskId,
            url: url,
            retry: retry,
            data: data,
            type: type,
            headers: headers,
            option: option,
            resolve: resolve,
            reject: reject
        };
        make_quest(taskId);
    });
}
exports.http_quest = http_quest;
function onResponse(taskid, res) {
    let task = task_cache[taskid];
    if (task) {
        task.res = res;
        if (res) {
            let size = Math.min(parseInt(res.headers["content-length"] || '1024'), 128 * 1024);
            task.respon_data = Buffer.alloc(size);
            task.respon_len = 0;
            res.on("data", onData.bind(null, taskid));
            res.on("end", onEnd.bind(null, taskid));
            res.on("error", onEnd.bind(null, taskid));
        }
        else if (!task.respon_data) {
            // 表示开始接收数据了，就不需要超时标志了
            if (task.retry > 0) {
                --task.retry;
            }
            else {
                onEnd(taskid);
            }
        }
    }
}
function onData(taskid, data) {
    let info = task_cache[taskid];
    if (!info || info.respon_len == undefined || info.respon_data == undefined)
        return;
    if (info.respon_len + data.length > info.respon_data.length) {
        // 数据不够放了，一般不存在,
        let nbuff = Buffer.alloc(info.respon_len + data.length + 2 * 1024); // 额外多2K的数据容量
        info.respon_data.copy(nbuff, 0, 0, info.respon_len);
        info.respon_data = nbuff;
    }
    info.respon_len += data.copy(info.respon_data, info.respon_len, 0, data.length);
}
function onEnd(taskid) {
    let info = task_cache[taskid];
    if (!info)
        return;
    let out = null;
    if (info.respon_data && info.respon_len) {
        out = info.respon_data.slice(0, info.respon_len);
    }
    switch (info.option.respon_type) {
        case 'json':
            try {
                out && (out = JSON.parse(out.toString()));
            }
            catch (e) {
                out && (out = out.toString());
            }
            break;
        case 'buffer':
            break;
        case 'text':
        case undefined:
            out && (out = out.toString());
            break;
        default:
            break;
    }
    if (out) {
        if (info.option.respon_head) {
            info.resolve([out, info.res ? info.res.headers : {}]);
        }
        else {
            info.resolve(out);
        }
    }
    else {
        if (info.option.respon_head) {
            info.reject(['404 ' + info.url, info.res ? info.res.headers : {}]);
        }
        else {
            info.reject('404 ' + info.url);
        }
    }
    delete task_cache[taskid];
}
function make_quest(taskId) {
    let task = task_cache[taskId];
    if (task.type == 'get') {
        http_get(task);
    }
    else if (task.type == 'post') {
        if (task.option.request_type == 'formdata') {
            let Needle = require('needle');
            Needle.post(task.url, task.data, { multipart: true }, function (err, res) {
                if (err) {
                    onEnd(taskId);
                    return;
                }
                let size = Math.min(parseInt(res.headers["content-length"] || '1024'), 128 * 1024);
                task.respon_data = Buffer.alloc(size);
                task.respon_len = 0;
                onData(taskId, res.raw);
                onEnd(taskId);
            });
        }
        else {
            http_post(task);
        }
    }
    else {
        process.nextTick(function () { onResponse(taskId); });
    }
}
function stringify(method, data) {
    if (typeof data == 'object') {
        let urldata = [];
        for (let key in data) {
            let value = data[key];
            if (typeof value == 'object') {
                value = JSON.stringify(value);
            }
            urldata.push(`${key}=${encodeURIComponent(value)}`);
        }
        return urldata.join('&');
    }
    if (data == undefined)
        data = '';
    return encodeURIComponent(data);
}
function http_get(task) {
    let url = task.url;
    let headers = task.headers;
    try {
        let urldata = stringify('get', task.data);
        if (urldata.length > 0) {
            if (url.indexOf('?') >= 0) {
                url = url + '&' + urldata;
            }
            else {
                url = url + '?' + urldata;
            }
        }
        let opt = URL.parse(url);
        if (headers) {
            if (!opt['headers'])
                opt['headers'] = {};
            for (let key in headers) {
                opt['headers'][key] = headers[key];
            }
        }
        let cert_info = cert_cache[task.option.ca_name || ''];
        if (cert_info) {
            opt.cert = cert_info.cert;
            opt.key = cert_info.key;
            opt.passphrase = cert_info.pass;
        }
        let r = (url.indexOf('https://') == 0) ? HTTPS.get(opt, function (res) { onResponse(task.taskId, res); }) : HTTP.get(opt, function (res) { onResponse(task.taskId, res); });
        r.on("error", function (e) { onResponse(task.taskId); });
        r.setTimeout(timeout_num, function () { onResponse(task.taskId); });
    }
    catch (e) {
        process.nextTick(function () { onResponse(task.taskId); });
    }
}
function http_post(task) {
    let url = task.url;
    let data = task.data;
    let headers = task.headers;
    let type = task.option.request_type || 'text';
    try {
        let contents = "";
        let Query = URL.parse(url);
        Query['method'] = 'POST';
        switch (type) {
            case 'plain': {
                contents = data;
                Query['headers'] = {
                    'Content-Type': 'text/plain',
                    'Content-Length': Buffer.byteLength(contents)
                };
                break;
            }
            case 'json': {
                if (typeof data == 'string') {
                    contents = data;
                }
                else {
                    contents = JSON.stringify(data);
                }
                Query['headers'] = {
                    'Content-Type': 'application/json',
                    'Content-Length': Buffer.byteLength(contents)
                };
                break;
            }
            case 'xml': {
                contents = data;
                Query['headers'] = {
                    'Content-Type': 'text/xml',
                };
                break;
            }
            default: {
                contents = stringify('post', data);
                Query['headers'] = {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Content-Length': contents.length
                };
                break;
            }
        }
        if (headers) {
            for (let key in headers) {
                Query['headers'][key] = headers[key];
            }
        }
        let cert_info = cert_cache[task.option.ca_name || ''];
        if (cert_info) {
            Query.cert = cert_info.cert;
            Query.key = cert_info.key;
            Query.passphrase = cert_info.pass;
        }
        let r = (url.indexOf('https://') == 0) ? HTTPS.request(Query, function (res) { onResponse(task.taskId, res); }) : HTTP.request(Query, function (res) { onResponse(task.taskId, res); });
        r.on("error", function () { onResponse(task.taskId); });
        r.write(contents, 'utf8');
        r.end();
        r.setTimeout(timeout_num, function () { onResponse(task.taskId); });
    }
    catch (e) {
        process.nextTick(function () { onResponse(task.taskId); });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSHR0cFF1ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiSHR0cFF1ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSw2Q0FBK0I7QUFDL0IsMkNBQTZCO0FBQzdCLHlDQUEyQjtBQUMzQiwyQkFBa0M7QUFLbEMsSUFBSSxXQUFXLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztBQUM1QixJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7QUFDbEIsU0FBUyxVQUFVO0lBQ2YsRUFBRSxTQUFTLENBQUM7SUFDWixPQUFPLFNBQVMsQ0FBQztBQUNyQixDQUFDO0FBMEJELElBQUksVUFBVSxHQUE0QixFQUFFLENBQUE7QUFFNUMsSUFBSSxVQUFVLEdBTVYsRUFBRSxDQUFDO0FBRVAsU0FBZ0IsUUFBUSxDQUFDLElBQVksRUFBRSxTQUFpQixFQUFFLFFBQWdCLEVBQUUsVUFBa0I7SUFDMUYsSUFBSTtRQUNBLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRztZQUNmLElBQUksRUFBRSxpQkFBWSxDQUFDLFNBQVMsQ0FBQztZQUM3QixHQUFHLEVBQUUsaUJBQVksQ0FBQyxRQUFRLENBQUM7WUFDM0IsSUFBSSxFQUFFLFVBQVU7U0FDbkIsQ0FBQTtRQUNELE9BQU8sSUFBSSxDQUFDO0tBQ2Y7SUFDRCxPQUFPLENBQUMsRUFBRTtRQUNOLE9BQU8sS0FBSyxDQUFDO0tBQ2hCO0FBQ0wsQ0FBQztBQVpELDRCQVlDO0FBRUQ7Ozs7Ozs7OztHQVNHO0FBQ0gsU0FBZ0IsVUFBVSxDQUFJLElBQTZCLEVBQUUsR0FBVyxFQUFFLE9BQVksRUFBRSxFQUFFLFFBQWdCLENBQUMsRUFBRSxVQUFlLEVBQUUsRUFBRSxPQUFrQztJQUM5SiwyQkFBMkI7SUFDM0IsSUFBSSxTQUFTLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEMsSUFBSSxTQUFTLElBQUksU0FBUyxJQUFJLFNBQVMs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QUcsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxVQUFVLEdBQUcsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RMLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLGNBQWMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3RELENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzFCLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNSLENBQUMsQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLGNBQWMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFBO0tBQ3JFO0lBQ0QsT0FBTyxDQUFDLEVBQUU7UUFDTixPQUFPLENBQUMsUUFBUSxDQUFDLGNBQWMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzdEO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgKiBhcyBIVFRQUyBmcm9tICdodHRwcyc7XHJcbmltcG9ydCAqIGFzIEhUVFAgZnJvbSAnaHR0cCc7XHJcbmltcG9ydCAqIGFzIFVSTCBmcm9tICd1cmwnO1xyXG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XHJcblxyXG50eXBlIFJlcXVlc3RUeXBlID0gJ3htbCcgfCAnanNvbicgfCAndGV4dCcgfCAncGxhaW4nIHwgJ2Zvcm1kYXRhJyB8IHVuZGVmaW5lZFxyXG50eXBlIFJlc3BvbnNlVHlwZSA9ICd0ZXh0JyB8ICdqc29uJyB8ICdidWZmZXInIHwgdW5kZWZpbmVkXHJcblxyXG52YXIgdGltZW91dF9udW0gPSAzMCAqIDEwMDA7XHJcbnZhciB0YXNrR2VuSWQgPSAwO1xyXG5mdW5jdGlvbiBtYWtlVGFza0lkKCkge1xyXG4gICAgKyt0YXNrR2VuSWQ7XHJcbiAgICByZXR1cm4gdGFza0dlbklkO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgaWZSZXF1ZXN0T3B0aW9uIHtcclxuICAgIHJlcXVlc3RfdHlwZT86IFJlcXVlc3RUeXBlLFxyXG4gICAgcmVzcG9uX3R5cGU/OiBSZXNwb25zZVR5cGUsXHJcbiAgICByZXNwb25faGVhZD86IGJvb2xlYW4sXHJcbiAgICBjYV9uYW1lPzogc3RyaW5nXHJcbn1cclxuXHJcbmludGVyZmFjZSBpZlRhc2sge1xyXG4gICAgdGFza0lkOiBudW1iZXIsXHJcbiAgICB1cmw6IHN0cmluZyxcclxuICAgIGhlYWRlcnM/OiBhbnksXHJcbiAgICB0eXBlOiBzdHJpbmcsXHJcbiAgICBkYXRhOiBhbnksXHJcbiAgICByZXRyeTogbnVtYmVyLFxyXG4gICAgcmVzPzogSFRUUC5JbmNvbWluZ01lc3NhZ2UsXHJcbiAgICByZXNwb25fZGF0YT86IEJ1ZmZlcixcclxuICAgIHJlc3Bvbl9sZW4/OiBudW1iZXIsXHJcblxyXG4gICAgb3B0aW9uOiBpZlJlcXVlc3RPcHRpb24sXHJcblxyXG4gICAgcmVzb2x2ZTogRnVuY3Rpb24sXHJcbiAgICByZWplY3Q6IEZ1bmN0aW9uXHJcbn1cclxuXHJcbnZhciB0YXNrX2NhY2hlOiB7IFt4OiBzdHJpbmddOiBpZlRhc2sgfSA9IHt9XHJcblxyXG5sZXQgY2VydF9jYWNoZToge1xyXG4gICAgW25hbWU6IHN0cmluZ106IHtcclxuICAgICAgICBjZXJ0OiBCdWZmZXIsXHJcbiAgICAgICAga2V5OiBCdWZmZXIsXHJcbiAgICAgICAgcGFzczogc3RyaW5nXHJcbiAgICB9XHJcbn0gPSB7fTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2FkQ2VydChuYW1lOiBzdHJpbmcsIGNlcnRfcGF0aDogc3RyaW5nLCBrZXlfcGF0aDogc3RyaW5nLCBwYXNzcGhyYXNlOiBzdHJpbmcpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY2VydF9jYWNoZVtuYW1lXSA9IHtcclxuICAgICAgICAgICAgY2VydDogcmVhZEZpbGVTeW5jKGNlcnRfcGF0aCksXHJcbiAgICAgICAgICAgIGtleTogcmVhZEZpbGVTeW5jKGtleV9wYXRoKSxcclxuICAgICAgICAgICAgcGFzczogcGFzc3BocmFzZVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG59XHJcblxyXG4vKipcclxuICog5byC5q2l5rWB56iL5omn6KGM572R57uc6K+35rGCXHJcbiAqIEBwYXJhbSB0eXBlIFxyXG4gKiBAcGFyYW0gdXJsIFxyXG4gKiBAcGFyYW0gZGF0YSBcclxuICogQHBhcmFtIHJldHJ5IFxyXG4gKiBAcGFyYW0gaGVhZGVycyBcclxuICogQHBhcmFtIGR0eXBlIFxyXG4gKiBAcGFyYW0gcnR5cGUgXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gaHR0cF9xdWVzdDxUPih0eXBlOiAnZ2V0JyB8ICdwb3N0JyB8IHN0cmluZywgdXJsOiBzdHJpbmcsIGRhdGE6IGFueSA9IHt9LCByZXRyeTogbnVtYmVyID0gMCwgaGVhZGVyczogYW55ID0ge30sIF9vcHRpb24/OiBpZlJlcXVlc3RPcHRpb24gfCBzdHJpbmcpOiBQcm9taXNlPFQ+IHtcclxuICAgIC8vIOi/memHjHVybOWinuWKoOS4gOS4qiBodHRwIGh0dHBzIOWktOajgOafpVxyXG4gICAgbGV0IGNoZWNrSGVhZCA9IHVybC5zbGljZSgwLCA3KTtcclxuICAgIGlmIChjaGVja0hlYWQgIT0gJ2h0dHA6Ly8nICYmIGNoZWNrSGVhZCAhPSAnaHR0cHM6LycpIHtcclxuICAgICAgICAvLyDoh6rliqjlop7liqDkuIDkuKrlpLTkuIrljrtcclxuICAgICAgICB1cmwgPSAnaHR0cDovLycgKyB1cmw7XHJcbiAgICB9XHJcblxyXG4gICAgdHlwZSA9IHR5cGUudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGxldCBvcHRpb246IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcclxuICAgICAgICBpZiAodHlwZW9mIF9vcHRpb24gPT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgb3B0aW9uID0geyBkdHlwZTogX29wdGlvbiB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgb3B0aW9uID0gT2JqZWN0LmFzc2lnbihvcHRpb24sIF9vcHRpb24gfHwge30pO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgdGFza0lkID0gbWFrZVRhc2tJZCgpO1xyXG4gICAgICAgIHRhc2tfY2FjaGVbdGFza0lkXSA9IHtcclxuICAgICAgICAgICAgdGFza0lkOiB0YXNrSWQsXHJcbiAgICAgICAgICAgIHVybDogdXJsLFxyXG4gICAgICAgICAgICByZXRyeTogcmV0cnksXHJcbiAgICAgICAgICAgIGRhdGE6IGRhdGEsXHJcbiAgICAgICAgICAgIHR5cGU6IHR5cGUsXHJcbiAgICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnMsXHJcbiAgICAgICAgICAgIG9wdGlvbjogb3B0aW9uLFxyXG4gICAgICAgICAgICByZXNvbHZlOiByZXNvbHZlLFxyXG4gICAgICAgICAgICByZWplY3Q6IHJlamVjdFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIG1ha2VfcXVlc3QodGFza0lkKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBvblJlc3BvbnNlKHRhc2tpZDogbnVtYmVyLCByZXM/OiBIVFRQLkluY29taW5nTWVzc2FnZSkge1xyXG4gICAgbGV0IHRhc2sgPSB0YXNrX2NhY2hlW3Rhc2tpZF07XHJcbiAgICBpZiAodGFzaykge1xyXG4gICAgICAgIHRhc2sucmVzID0gcmVzO1xyXG4gICAgICAgIGlmIChyZXMpIHtcclxuICAgICAgICAgICAgbGV0IHNpemUgPSBNYXRoLm1pbihwYXJzZUludChyZXMuaGVhZGVyc1tcImNvbnRlbnQtbGVuZ3RoXCJdIHx8ICcxMDI0JyksIDEyOCAqIDEwMjQpO1xyXG4gICAgICAgICAgICB0YXNrLnJlc3Bvbl9kYXRhID0gQnVmZmVyLmFsbG9jKHNpemUpO1xyXG4gICAgICAgICAgICB0YXNrLnJlc3Bvbl9sZW4gPSAwO1xyXG5cclxuICAgICAgICAgICAgcmVzLm9uKFwiZGF0YVwiLCBvbkRhdGEuYmluZChudWxsLCB0YXNraWQpKTtcclxuICAgICAgICAgICAgcmVzLm9uKFwiZW5kXCIsIG9uRW5kLmJpbmQobnVsbCwgdGFza2lkKSk7XHJcbiAgICAgICAgICAgIHJlcy5vbihcImVycm9yXCIsIG9uRW5kLmJpbmQobnVsbCwgdGFza2lkKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKCF0YXNrLnJlc3Bvbl9kYXRhKSB7XHJcbiAgICAgICAgICAgIC8vIOihqOekuuW8gOWni+aOpeaUtuaVsOaNruS6hu+8jOWwseS4jemcgOimgei2heaXtuagh+W/l+S6hlxyXG4gICAgICAgICAgICBpZiAodGFzay5yZXRyeSA+IDApIHtcclxuICAgICAgICAgICAgICAgIC0tdGFzay5yZXRyeTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG9uRW5kKHRhc2tpZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG9uRGF0YSh0YXNraWQ6IG51bWJlciwgZGF0YTogQnVmZmVyKSB7XHJcbiAgICBsZXQgaW5mbyA9IHRhc2tfY2FjaGVbdGFza2lkXTtcclxuICAgIGlmICghaW5mbyB8fCBpbmZvLnJlc3Bvbl9sZW4gPT0gdW5kZWZpbmVkIHx8IGluZm8ucmVzcG9uX2RhdGEgPT0gdW5kZWZpbmVkKSByZXR1cm47XHJcbiAgICBpZiAoaW5mby5yZXNwb25fbGVuICsgZGF0YS5sZW5ndGggPiBpbmZvLnJlc3Bvbl9kYXRhLmxlbmd0aCkge1xyXG4gICAgICAgIC8vIOaVsOaNruS4jeWkn+aUvuS6hu+8jOS4gOiIrOS4jeWtmOWcqCxcclxuICAgICAgICBsZXQgbmJ1ZmYgPSBCdWZmZXIuYWxsb2MoaW5mby5yZXNwb25fbGVuICsgZGF0YS5sZW5ndGggKyAyICogMTAyNCk7IC8vIOmineWkluWkmjJL55qE5pWw5o2u5a656YePXHJcbiAgICAgICAgaW5mby5yZXNwb25fZGF0YS5jb3B5KG5idWZmLCAwLCAwLCBpbmZvLnJlc3Bvbl9sZW4pO1xyXG4gICAgICAgIGluZm8ucmVzcG9uX2RhdGEgPSBuYnVmZjtcclxuICAgIH1cclxuXHJcbiAgICBpbmZvLnJlc3Bvbl9sZW4gKz0gZGF0YS5jb3B5KGluZm8ucmVzcG9uX2RhdGEsIGluZm8ucmVzcG9uX2xlbiwgMCwgZGF0YS5sZW5ndGgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBvbkVuZCh0YXNraWQ6IG51bWJlcikge1xyXG4gICAgbGV0IGluZm8gPSB0YXNrX2NhY2hlW3Rhc2tpZF07XHJcbiAgICBpZiAoIWluZm8pIHJldHVybjtcclxuICAgIGxldCBvdXQgPSBudWxsO1xyXG4gICAgaWYgKGluZm8ucmVzcG9uX2RhdGEgJiYgaW5mby5yZXNwb25fbGVuKSB7XHJcbiAgICAgICAgb3V0ID0gaW5mby5yZXNwb25fZGF0YS5zbGljZSgwLCBpbmZvLnJlc3Bvbl9sZW4pO1xyXG4gICAgfVxyXG5cclxuICAgIHN3aXRjaCAoaW5mby5vcHRpb24ucmVzcG9uX3R5cGUpIHtcclxuICAgICAgICBjYXNlICdqc29uJzpcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIG91dCAmJiAob3V0ID0gSlNPTi5wYXJzZShvdXQudG9TdHJpbmcoKSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBvdXQgJiYgKG91dCA9IG91dC50b1N0cmluZygpKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2J1ZmZlcic6XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgICAgIGNhc2UgdW5kZWZpbmVkOlxyXG4gICAgICAgICAgICBvdXQgJiYgKG91dCA9IG91dC50b1N0cmluZygpKVxyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG91dCkge1xyXG4gICAgICAgIGlmIChpbmZvLm9wdGlvbi5yZXNwb25faGVhZCkge1xyXG4gICAgICAgICAgICBpbmZvLnJlc29sdmUoW291dCwgaW5mby5yZXMgPyBpbmZvLnJlcy5oZWFkZXJzIDoge31dKVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgaW5mby5yZXNvbHZlKG91dClcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBpZiAoaW5mby5vcHRpb24ucmVzcG9uX2hlYWQpIHtcclxuICAgICAgICAgICAgaW5mby5yZWplY3QoWyc0MDQgJyArIGluZm8udXJsLCBpbmZvLnJlcyA/IGluZm8ucmVzLmhlYWRlcnMgOiB7fV0pXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBpbmZvLnJlamVjdCgnNDA0ICcgKyBpbmZvLnVybClcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBkZWxldGUgdGFza19jYWNoZVt0YXNraWRdO1xyXG59XHJcblxyXG5mdW5jdGlvbiBtYWtlX3F1ZXN0KHRhc2tJZDogbnVtYmVyKSB7XHJcbiAgICBsZXQgdGFzayA9IHRhc2tfY2FjaGVbdGFza0lkXVxyXG4gICAgaWYgKHRhc2sudHlwZSA9PSAnZ2V0Jykge1xyXG4gICAgICAgIGh0dHBfZ2V0KHRhc2spO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAodGFzay50eXBlID09ICdwb3N0Jykge1xyXG4gICAgICAgIGlmICh0YXNrLm9wdGlvbi5yZXF1ZXN0X3R5cGUgPT0gJ2Zvcm1kYXRhJykge1xyXG4gICAgICAgICAgICBsZXQgTmVlZGxlID0gcmVxdWlyZSgnbmVlZGxlJyk7XHJcbiAgICAgICAgICAgIE5lZWRsZS5wb3N0KHRhc2sudXJsLCB0YXNrLmRhdGEsIHsgbXVsdGlwYXJ0OiB0cnVlIH0sIGZ1bmN0aW9uIChlcnI6IEVycm9yLCByZXM6IGFueSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIG9uRW5kKHRhc2tJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGxldCBzaXplID0gTWF0aC5taW4ocGFyc2VJbnQocmVzLmhlYWRlcnNbXCJjb250ZW50LWxlbmd0aFwiXSB8fCAnMTAyNCcpLCAxMjggKiAxMDI0KTtcclxuICAgICAgICAgICAgICAgIHRhc2sucmVzcG9uX2RhdGEgPSBCdWZmZXIuYWxsb2Moc2l6ZSk7XHJcbiAgICAgICAgICAgICAgICB0YXNrLnJlc3Bvbl9sZW4gPSAwO1xyXG4gICAgICAgICAgICAgICAgb25EYXRhKHRhc2tJZCwgcmVzLnJhdylcclxuICAgICAgICAgICAgICAgIG9uRW5kKHRhc2tJZCk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBodHRwX3Bvc3QodGFzaylcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uICgpIHsgb25SZXNwb25zZSh0YXNrSWQpIH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBzdHJpbmdpZnkobWV0aG9kOiBzdHJpbmcsIGRhdGE6IGFueSkge1xyXG4gICAgaWYgKHR5cGVvZiBkYXRhID09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgbGV0IHVybGRhdGEgPSBbXTtcclxuICAgICAgICBmb3IgKGxldCBrZXkgaW4gZGF0YSkge1xyXG4gICAgICAgICAgICBsZXQgdmFsdWUgPSBkYXRhW2tleV07XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB1cmxkYXRhLnB1c2goYCR7a2V5fT0ke2VuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSl9YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB1cmxkYXRhLmpvaW4oJyYnKVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChkYXRhID09IHVuZGVmaW5lZCkgZGF0YSA9ICcnO1xyXG4gICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChkYXRhKTtcclxufVxyXG5cclxuZnVuY3Rpb24gaHR0cF9nZXQodGFzazogaWZUYXNrKSB7XHJcbiAgICBsZXQgdXJsID0gdGFzay51cmw7XHJcbiAgICBsZXQgaGVhZGVycyA9IHRhc2suaGVhZGVycztcclxuICAgIHRyeSB7XHJcbiAgICAgICAgbGV0IHVybGRhdGEgPSBzdHJpbmdpZnkoJ2dldCcsIHRhc2suZGF0YSk7XHJcbiAgICAgICAgaWYgKHVybGRhdGEubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBpZiAodXJsLmluZGV4T2YoJz8nKSA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICB1cmwgPSB1cmwgKyAnJicgKyB1cmxkYXRhO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdXJsID0gdXJsICsgJz8nICsgdXJsZGF0YTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IG9wdDogSFRUUFMuUmVxdWVzdE9wdGlvbnMgPSBVUkwucGFyc2UodXJsKSBhcyBhbnk7XHJcbiAgICAgICAgaWYgKGhlYWRlcnMpIHtcclxuICAgICAgICAgICAgaWYgKCFvcHRbJ2hlYWRlcnMnXSkgb3B0WydoZWFkZXJzJ10gPSB7fTtcclxuICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIGhlYWRlcnMpIHtcclxuICAgICAgICAgICAgICAgIG9wdFsnaGVhZGVycyddW2tleV0gPSBoZWFkZXJzW2tleV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBjZXJ0X2luZm8gPSBjZXJ0X2NhY2hlW3Rhc2sub3B0aW9uLmNhX25hbWUgfHwgJyddO1xyXG4gICAgICAgIGlmIChjZXJ0X2luZm8pIHtcclxuICAgICAgICAgICAgb3B0LmNlcnQgPSBjZXJ0X2luZm8uY2VydDtcclxuICAgICAgICAgICAgb3B0LmtleSA9IGNlcnRfaW5mby5rZXk7XHJcbiAgICAgICAgICAgIG9wdC5wYXNzcGhyYXNlID0gY2VydF9pbmZvLnBhc3M7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgciA9ICh1cmwuaW5kZXhPZignaHR0cHM6Ly8nKSA9PSAwKSA/IEhUVFBTLmdldChvcHQsIGZ1bmN0aW9uIChyZXMpIHsgb25SZXNwb25zZSh0YXNrLnRhc2tJZCwgcmVzKTsgfSkgOiBIVFRQLmdldChvcHQsIGZ1bmN0aW9uIChyZXMpIHsgb25SZXNwb25zZSh0YXNrLnRhc2tJZCwgcmVzKTsgfSk7XHJcbiAgICAgICAgci5vbihcImVycm9yXCIsIGZ1bmN0aW9uIChlOiBFcnJvcikgeyBvblJlc3BvbnNlKHRhc2sudGFza0lkKTsgfSlcclxuICAgICAgICByLnNldFRpbWVvdXQodGltZW91dF9udW0sIGZ1bmN0aW9uICgpIHsgb25SZXNwb25zZSh0YXNrLnRhc2tJZCk7IH0pXHJcbiAgICB9XHJcbiAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24gKCkgeyBvblJlc3BvbnNlKHRhc2sudGFza0lkKTsgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGh0dHBfcG9zdCh0YXNrOiBpZlRhc2spIHtcclxuICAgIGxldCB1cmwgPSB0YXNrLnVybDtcclxuICAgIGxldCBkYXRhID0gdGFzay5kYXRhO1xyXG4gICAgbGV0IGhlYWRlcnMgPSB0YXNrLmhlYWRlcnM7XHJcbiAgICBsZXQgdHlwZSA9IHRhc2sub3B0aW9uLnJlcXVlc3RfdHlwZSB8fCAndGV4dCc7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGxldCBjb250ZW50cyA9IFwiXCI7XHJcbiAgICAgICAgbGV0IFF1ZXJ5OiBIVFRQUy5SZXF1ZXN0T3B0aW9ucyA9IFVSTC5wYXJzZSh1cmwpIGFzIGFueTtcclxuICAgICAgICBRdWVyeVsnbWV0aG9kJ10gPSAnUE9TVCc7XHJcblxyXG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICdwbGFpbic6IHtcclxuICAgICAgICAgICAgICAgIGNvbnRlbnRzID0gZGF0YTtcclxuICAgICAgICAgICAgICAgIFF1ZXJ5WydoZWFkZXJzJ10gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICd0ZXh0L3BsYWluJyxcclxuICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGgnOiBCdWZmZXIuYnl0ZUxlbmd0aChjb250ZW50cylcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgJ2pzb24nOiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250ZW50cyA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250ZW50cyA9IEpTT04uc3RyaW5naWZ5KGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgUXVlcnlbJ2hlYWRlcnMnXSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICAgICAgICAgICAgICdDb250ZW50LUxlbmd0aCc6IEJ1ZmZlci5ieXRlTGVuZ3RoKGNvbnRlbnRzKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSAneG1sJzoge1xyXG4gICAgICAgICAgICAgICAgY29udGVudHMgPSBkYXRhO1xyXG4gICAgICAgICAgICAgICAgUXVlcnlbJ2hlYWRlcnMnXSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ3RleHQveG1sJyxcclxuICAgICAgICAgICAgICAgICAgICAvLyAnQ29udGVudC1MZW5ndGgnOiBjb250ZW50cy5sZW5ndGhcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6IHtcclxuICAgICAgICAgICAgICAgIGNvbnRlbnRzID0gc3RyaW5naWZ5KCdwb3N0JywgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBRdWVyeVsnaGVhZGVycyddID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyxcclxuICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGgnOiBjb250ZW50cy5sZW5ndGhcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoaGVhZGVycykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gaGVhZGVycykge1xyXG4gICAgICAgICAgICAgICAgUXVlcnlbJ2hlYWRlcnMnXVtrZXldID0gaGVhZGVyc1trZXldO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgY2VydF9pbmZvID0gY2VydF9jYWNoZVt0YXNrLm9wdGlvbi5jYV9uYW1lIHx8ICcnXTtcclxuICAgICAgICBpZiAoY2VydF9pbmZvKSB7XHJcbiAgICAgICAgICAgIFF1ZXJ5LmNlcnQgPSBjZXJ0X2luZm8uY2VydDtcclxuICAgICAgICAgICAgUXVlcnkua2V5ID0gY2VydF9pbmZvLmtleTtcclxuICAgICAgICAgICAgUXVlcnkucGFzc3BocmFzZSA9IGNlcnRfaW5mby5wYXNzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHIgPSAodXJsLmluZGV4T2YoJ2h0dHBzOi8vJykgPT0gMCkgPyBIVFRQUy5yZXF1ZXN0KFF1ZXJ5LCBmdW5jdGlvbiAocmVzKSB7IG9uUmVzcG9uc2UodGFzay50YXNrSWQsIHJlcykgfSkgOiBIVFRQLnJlcXVlc3QoUXVlcnksIGZ1bmN0aW9uIChyZXMpIHsgb25SZXNwb25zZSh0YXNrLnRhc2tJZCwgcmVzKSB9KTtcclxuICAgICAgICByLm9uKFwiZXJyb3JcIiwgZnVuY3Rpb24gKCkgeyBvblJlc3BvbnNlKHRhc2sudGFza0lkKSB9KVxyXG4gICAgICAgIHIud3JpdGUoY29udGVudHMsICd1dGY4Jyk7XHJcbiAgICAgICAgci5lbmQoKTtcclxuICAgICAgICByLnNldFRpbWVvdXQodGltZW91dF9udW0sIGZ1bmN0aW9uICgpIHsgb25SZXNwb25zZSh0YXNrLnRhc2tJZCkgfSlcclxuICAgIH1cclxuICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbiAoKSB7IG9uUmVzcG9uc2UodGFzay50YXNrSWQpIH0pO1xyXG4gICAgfVxyXG59Il19