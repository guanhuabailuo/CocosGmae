"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebRouteUnit = void 0;
const express_1 = __importDefault(require("express"));
const body_parser_1 = __importDefault(require("body-parser"));
const fs_1 = require("fs");
const path_1 = require("path");
const zlib_1 = require("zlib");
const compression_1 = __importDefault(require("compression"));
const debug_1 = require("debug");
const express_http_proxy_1 = __importDefault(require("express-http-proxy"));
let Debug = debug_1.debug("mx-webserve");
let gRoutePath = process.mainModule ? path_1.parse(process.mainModule.filename).dir : process.cwd();
class WebRouteUnit {
    constructor() {
        this.app = express_1.default();
    }
    use(...handlers) {
        if (this.app)
            this.app.use(...handlers);
    }
    // 静态资源
    static(pre, root) {
        return this.app.use(pre, express_1.default.static(root, {}));
    }
    // 增加代理接口
    proxy(pre, host, options) {
        return this.app.use(pre, express_http_proxy_1.default(host, options));
    }
    /**
     * 开启配置
     * @param setting
     */
    enable(setting) {
        this.app.enable(setting);
    }
    /**
     * 关闭配置
     * @param setting
     */
    disable(setting) {
        this.app.disable(setting);
    }
    _crossUse(req, res, next) {
        if (this.app.enabled("cross")) {
            res.header("Access-Control-Allow-Origin", "*");
            res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
            res.header("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
        }
        next();
    }
    _options(req, res, next) {
        res.end();
    }
    _404(req, res, next) {
        if (!res.headersSent) {
            // 表示有人处理过了
            res.writeHead(404);
            res.write(JSON.stringify({
                code: -1,
                errMsg: "can not find --------- [" + req.path + "]"
            }));
        }
        res.end();
    }
    init(port, uses, limit) {
        if (this.app.enabled("init"))
            return Promise.resolve();
        this.app.use(this._crossUse.bind(this));
        this.app.options("*", this._options.bind(this));
        if (typeof limit == 'string') {
            limit = {
                text: limit,
                json: limit,
                urlencoded: limit,
                raw: limit,
            };
        }
        else if (limit == undefined) {
            limit = {};
        }
        this.app.use(body_parser_1.default.text({ limit: limit.text || '100kb' }));
        this.app.use(body_parser_1.default.raw({ limit: limit.raw || '100kb' }));
        this.app.use(body_parser_1.default.urlencoded({ extended: true, limit: limit.urlencoded || "10mb" }));
        this.app.use(body_parser_1.default.json({ limit: limit.json || '100kb' }));
        if (limit.gzip == true)
            this.app.use(compression_1.default());
        // 注册一下别人提交的内容
        this.app.use(this.favicon.bind(this));
        for (let i = 0; i < uses.length; i++) {
            this.app.use(uses[i]);
        }
        this.app.use(this._404.bind(this));
        this.load_favicon();
        this.app.enable("init");
        let server = this.app.listen(port);
        return new Promise((resolve, reject) => {
            // 建立一个web监控
            server.on("error", function (e) {
                Debug(e);
                reject(e);
            });
            server.on("listening", () => {
                Debug("listen on:" + port);
                resolve();
            });
        });
    }
    load_favicon() {
        try {
            this.favicon_data = zlib_1.gzipSync(fs_1.readFileSync(path_1.join(gRoutePath, "favicon.ico")));
        }
        catch (e) { }
    }
    favicon(req, res, next) {
        if (req.url == "/favicon.ico") {
            if (!this.favicon_data) {
                res.status(404);
            }
            else {
                res.writeHead(200, { "Content-Type": "image/x-icon", "Content-Encoding": "gzip" });
                res.write(this.favicon_data);
            }
            res.end();
        }
        else {
            next();
        }
    }
}
exports.WebRouteUnit = WebRouteUnit;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHNEQUFtRTtBQUNuRSw4REFBcUM7QUFDckMsMkJBQWtDO0FBQ2xDLCtCQUFtQztBQUNuQywrQkFBZ0M7QUFFaEMsOERBQXFDO0FBRXJDLGlDQUE4QjtBQUM5Qiw0RUFBdUM7QUFDdkMsSUFBSSxLQUFLLEdBQUcsYUFBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBR2pDLElBQUksVUFBVSxHQUFJLE9BQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLFlBQUssQ0FBRSxPQUFlLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBTS9HLE1BQWEsWUFBWTtJQUNyQjtRQUdBLFFBQUcsR0FBd0IsaUJBQU8sRUFBRSxDQUFDO0lBRnJDLENBQUM7SUFHTSxHQUFHLENBQUMsR0FBRyxRQUFlO1FBQ3pCLElBQUksSUFBSSxDQUFDLEdBQUc7WUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRCxPQUFPO0lBQ1AsTUFBTSxDQUFDLEdBQVcsRUFBRSxJQUFZO1FBQzVCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLGlCQUFPLENBQUMsTUFBTSxDQUFNLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBQzNELENBQUM7SUFFRCxTQUFTO0lBQ1QsS0FBSyxDQUFDLEdBQVcsRUFBRSxJQUF5QyxFQUFFLE9BQXVCO1FBQ2pGLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLDRCQUFLLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUE7SUFDbEQsQ0FBQztJQUVEOzs7T0FHRztJQUNILE1B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LENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxDQUFDO2dCQUMzQixPQUFPLEVBQUUsQ0FBQTtZQUNiLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0lBR0QsWUFBWTtRQUNSLElBQUk7WUFDQSxJQUFJLENBQUMsWUFBWSxHQUFHLGVBQVEsQ0FDeEIsaUJBQVksQ0FBQyxXQUFJLENBQUMsVUFBVSxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQ2hELENBQUM7U0FDTDtRQUFDLE9BQU8sQ0FBQyxFQUFFLEdBQUc7SUFDbkIsQ0FBQztJQUVPLE9BQU8sQ0FBQyxHQUFvQixFQUFFLEdBQXFCLEVBQUUsSUFBMEI7UUFDbkYsSUFBSSxHQUFHLENBQUMsR0FBRyxJQUFJLGNBQWMsRUFBRTtZQUMzQixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDcEIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTthQUNsQjtpQkFDSTtnQkFDRCxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztnQkFDbkYsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDaEM7WUFDRCxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDYjthQUFNO1lBQ0gsSUFBSSxFQUFFLENBQUM7U0FDVjtJQUNMLENBQUM7Q0FDSjtBQXRJRCxvQ0FzSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRXhwcmVzcywgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSBcImV4cHJlc3NcIjtcbmltcG9ydCBib2R5UGFyc2VyIGZyb20gXCJib2R5LXBhcnNlclwiO1xuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSBcImZzXCI7XG5pbXBvcnQgeyBqb2luLCBwYXJzZSB9IGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBnemlwU3luYyB9IGZyb20gXCJ6bGliXCI7XG5cbmltcG9ydCBjb21wcmVzc2lvbiBmcm9tICdjb21wcmVzc2lvbidcblxuaW1wb3J0IHsgZGVidWcgfSBmcm9tIFwiZGVidWdcIjtcbmltcG9ydCBwcm94eSBmcm9tIFwiZXhwcmVzcy1odHRwLXByb3h5XCI7XG5sZXQgRGVidWcgPSBkZWJ1ZyhcIm14LXdlYnNlcnZlXCIpO1xuXG5cbmxldCBnUm91dGVQYXRoID0gKHByb2Nlc3MgYXMgYW55KS5tYWluTW9kdWxlID8gcGFyc2UoKHByb2Nlc3MgYXMgYW55KS5tYWluTW9kdWxlLmZpbGVuYW1lKS5kaXIgOiBwcm9jZXNzLmN3ZCgpO1xuXG5leHBvcnQgaW50ZXJmYWNlIElQcm94eU9wdGlvbnMgZXh0ZW5kcyBwcm94eS5Qcm94eU9wdGlvbnMge1xuXG59XG5cbmV4cG9ydCBjbGFzcyBXZWJSb3V0ZVVuaXQge1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgIH1cblxuICAgIGFwcDogRXhwcmVzcy5BcHBsaWNhdGlvbiA9IEV4cHJlc3MoKTtcbiAgICBwdWJsaWMgdXNlKC4uLmhhbmRsZXJzOiBhbnlbXSkge1xuICAgICAgICBpZiAodGhpcy5hcHApIHRoaXMuYXBwLnVzZSguLi5oYW5kbGVycyk7XG4gICAgfVxuXG4gICAgLy8g6Z2Z5oCB6LWE5rqQXG4gICAgc3RhdGljKHByZTogc3RyaW5nLCByb290OiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwLnVzZShwcmUsIEV4cHJlc3Muc3RhdGljPGFueT4ocm9vdCwge30pKVxuICAgIH1cblxuICAgIC8vIOWinuWKoOS7o+eQhuaOpeWPo1xuICAgIHByb3h5KHByZTogc3RyaW5nLCBob3N0OiBzdHJpbmcgfCAoKHJlcTogUmVxdWVzdCkgPT4gc3RyaW5nKSwgb3B0aW9ucz86IElQcm94eU9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwLnVzZShwcmUsIHByb3h5KGhvc3QsIG9wdGlvbnMpKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOW8gOWQr+mFjee9rlxuICAgICAqIEBwYXJhbSBzZXR0aW5nIFxuICAgICAqL1xuICAgIGVuYWJsZShzZXR0aW5nOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5hcHAuZW5hYmxlKHNldHRpbmcpXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5YWz6Zet6YWN572uXG4gICAgICogQHBhcmFtIHNldHRpbmcgXG4gICAgICovXG4gICAgZGlzYWJsZShzZXR0aW5nOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5hcHAuZGlzYWJsZShzZXR0aW5nKVxuICAgIH1cblxuICAgIHByaXZhdGUgX2Nyb3NzVXNlKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgICAgIGlmICh0aGlzLmFwcC5lbmFibGVkKFwiY3Jvc3NcIikpIHtcbiAgICAgICAgICAgIHJlcy5oZWFkZXIoXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW5cIiwgXCIqXCIpO1xuICAgICAgICAgICAgcmVzLmhlYWRlcihcIkFjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnNcIiwgXCJPcmlnaW4sIFgtUmVxdWVzdGVkLVdpdGgsIENvbnRlbnQtVHlwZSwgQWNjZXB0XCIpO1xuICAgICAgICAgICAgcmVzLmhlYWRlcihcIkFjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHNcIiwgXCJHRVQsUE9TVCxPUFRJT05TXCIpO1xuICAgICAgICB9XG4gICAgICAgIG5leHQoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9vcHRpb25zKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgICAgIHJlcy5lbmQoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF80MDQocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICAgICAgaWYgKCFyZXMuaGVhZGVyc1NlbnQpIHtcbiAgICAgICAgICAgIC8vIOihqOekuuacieS6uuWkhOeQhui/h+S6hlxuICAgICAgICAgICAgcmVzLndyaXRlSGVhZCg0MDQpO1xuICAgICAgICAgICAgcmVzLndyaXRlKFxuICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgY29kZTogLTEsXG4gICAgICAgICAgICAgICAgICAgIGVyck1zZzogXCJjYW4gbm90IGZpbmQgW1wiICsgcmVxLnBhdGggKyBcIl1cIlxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJlcy5lbmQoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaW5pdChwb3J0OiBudW1iZXIsIHVzZXM6IGFueVtdLCBsaW1pdD86IHN0cmluZyB8IHsganNvbj86IHN0cmluZywgdGV4dD86IHN0cmluZywgcmF3Pzogc3RyaW5nLCB1cmxlbmNvZGVkPzogc3RyaW5nLCBnemlwPzogYm9vbGVhbiwgW3g6IHN0cmluZ106IHN0cmluZyB8IGJvb2xlYW4gfCB1bmRlZmluZWQgfSkge1xuICAgICAgICBpZiAodGhpcy5hcHAuZW5hYmxlZChcImluaXRcIikpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgICB0aGlzLmFwcC51c2UodGhpcy5fY3Jvc3NVc2UuYmluZCh0aGlzKSk7XG4gICAgICAgIHRoaXMuYXBwLm9wdGlvbnMoXCIqXCIsIHRoaXMuX29wdGlvbnMuYmluZCh0aGlzKSk7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBsaW1pdCA9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgbGltaXQgPSB7XG4gICAgICAgICAgICAgICAgdGV4dDogbGltaXQsXG4gICAgICAgICAgICAgICAganNvbjogbGltaXQsXG4gICAgICAgICAgICAgICAgdXJsZW5jb2RlZDogbGltaXQsXG4gICAgICAgICAgICAgICAgcmF3OiBsaW1pdCxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChsaW1pdCA9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGxpbWl0ID0ge307XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmFwcC51c2UoYm9keVBhcnNlci50ZXh0KHsgbGltaXQ6IGxpbWl0LnRleHQgfHwgJzEwMGtiJyB9KSk7XG4gICAgICAgIHRoaXMuYXBwLnVzZShib2R5UGFyc2VyLnJhdyh7IGxpbWl0OiBsaW1pdC5yYXcgfHwgJzEwMGtiJyB9KSk7XG4gICAgICAgIHRoaXMuYXBwLnVzZShib2R5UGFyc2VyLnVybGVuY29kZWQoeyBleHRlbmRlZDogdHJ1ZSwgbGltaXQ6IGxpbWl0LnVybGVuY29kZWQgfHwgXCIxMG1iXCIgfSkpO1xuICAgICAgICB0aGlzLmFwcC51c2UoYm9keVBhcnNlci5qc29uKHsgbGltaXQ6IGxpbWl0Lmpzb24gfHwgJzEwMGtiJyB9KSk7XG4gICAgICAgIGlmIChsaW1pdC5nemlwID09IHRydWUpIHRoaXMuYXBwLnVzZShjb21wcmVzc2lvbigpKTtcblxuICAgICAgICAvLyDms6jlhozkuIDkuIvliKvkurrmj5DkuqTnmoTlhoXlrrlcblxuICAgICAgICB0aGlzLmFwcC51c2UodGhpcy5mYXZpY29uLmJpbmQodGhpcykpO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVzZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMuYXBwLnVzZSh1c2VzW2ldKVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5hcHAudXNlKHRoaXMuXzQwNC5iaW5kKHRoaXMpKTtcblxuICAgICAgICB0aGlzLmxvYWRfZmF2aWNvbigpO1xuICAgICAgICB0aGlzLmFwcC5lbmFibGUoXCJpbml0XCIpO1xuICAgICAgICBsZXQgc2VydmVyID0gdGhpcy5hcHAubGlzdGVuKHBvcnQpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgLy8g5bu656uL5LiA5Liqd2Vi55uR5o6nXG4gICAgICAgICAgICBzZXJ2ZXIub24oXCJlcnJvclwiLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIERlYnVnKGUpO1xuICAgICAgICAgICAgICAgIHJlamVjdChlKVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHNlcnZlci5vbihcImxpc3RlbmluZ1wiLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgRGVidWcoXCJsaXN0ZW4gb246XCIgKyBwb3J0KTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKClcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgIH1cblxuICAgIHByaXZhdGUgZmF2aWNvbl9kYXRhITogQnVmZmVyO1xuICAgIGxvYWRfZmF2aWNvbigpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMuZmF2aWNvbl9kYXRhID0gZ3ppcFN5bmMoXG4gICAgICAgICAgICAgICAgcmVhZEZpbGVTeW5jKGpvaW4oZ1JvdXRlUGF0aCwgXCJmYXZpY29uLmljb1wiKSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHsgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZmF2aWNvbihyZXE6IEV4cHJlc3MuUmVxdWVzdCwgcmVzOiBFeHByZXNzLlJlc3BvbnNlLCBuZXh0OiBFeHByZXNzLk5leHRGdW5jdGlvbikge1xuICAgICAgICBpZiAocmVxLnVybCA9PSBcIi9mYXZpY29uLmljb1wiKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZmF2aWNvbl9kYXRhKSB7XG4gICAgICAgICAgICAgICAgcmVzLnN0YXR1cyg0MDQpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXMud3JpdGVIZWFkKDIwMCwgeyBcIkNvbnRlbnQtVHlwZVwiOiBcImltYWdlL3gtaWNvblwiLCBcIkNvbnRlbnQtRW5jb2RpbmdcIjogXCJnemlwXCIgfSk7XG4gICAgICAgICAgICAgICAgcmVzLndyaXRlKHRoaXMuZmF2aWNvbl9kYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlcy5lbmQoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==